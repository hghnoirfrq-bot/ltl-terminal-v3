<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUCTHELEO Terminal - Creative Coaching System</title>
    <!-- Stripe.js library -->
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'JetBrains Mono', monospace; background-color: #0a0a0a; color: #00ff00; min-height: 100vh; position: relative; overflow-x: hidden; }
        #matrix-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
        .matrix-column { position: absolute; top: -100%; font-size: 20px; color: #0f0; text-shadow: 0 0 5px #0f0; animation: matrix-fall linear infinite; }
        @keyframes matrix-fall { to { top: 100%; } }
        .terminal-container { max-width: 1200px; margin: 0 auto; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; }
        .terminal-window { background-color: rgba(20, 20, 20, 0.95); border-radius: 8px; box-shadow: 0 0 20px rgba(0, 255, 0, 0.3); overflow: hidden; margin-bottom: 20px; }
        .terminal-header { background: linear-gradient(to bottom, #3a3a3a, #2a2a2a); padding: 10px 15px; display: flex; align-items: center; gap: 8px; }
        .terminal-button { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .terminal-button.red { background-color: #ff5f56; } .terminal-button.yellow { background-color: #ffbd2e; } .terminal-button.green { background-color: #27c93f; }
        .terminal-title { margin-left: auto; margin-right: auto; color: #888; font-size: 12px; }
        .terminal-body { padding: 20px; min-height: 400px; max-height: 600px; overflow-y: auto; }
        .terminal-output { margin-bottom: 20px; line-height: 1.6; white-space: pre-wrap; }
        .terminal-line { margin-bottom: 10px; }
        .command-line { display: flex; align-items: center; margin-top: 10px; }
        .prompt { color: #00ff00; margin-right: 10px; }
        #terminal-input { background: transparent; border: none; color: #00ff00; font-family: 'JetBrains Mono', monospace; font-size: 14px; flex: 1; outline: none; }
        .cursor { display: inline-block; width: 10px; height: 20px; background-color: #00ff00; animation: blink 1s infinite; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
        .nav-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px; }
        .nav-card { background: linear-gradient(135deg, rgba(0, 255, 0, 0.1), rgba(0, 255, 0, 0.05)); border: 1px solid rgba(0, 255, 0, 0.3); border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .nav-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0, 255, 0, 0.3); border-color: #00ff00; }
        .nav-card h3 { color: #00ff00; margin-bottom: 10px; font-size: 18px; }
        .nav-card p { color: #888; font-size: 12px; line-height: 1.4; }
        .form-container { background: rgba(20, 20, 20, 0.95); border-radius: 8px; padding: 30px; margin-top: 20px; border: 1px solid rgba(0, 255, 0, 0.3); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #00ff00; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; background: rgba(0, 255, 0, 0.05); border: 1px solid rgba(0, 255, 0, 0.3); border-radius: 4px; color: #00ff00; font-family: 'JetBrains Mono', monospace; font-size: 14px; transition: all 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #00ff00; box-shadow: 0 0 10px rgba(0, 255, 0, 0.3); }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .btn { padding: 12px 30px; background: linear-gradient(135deg, #00ff00, #00cc00); color: #000; border: none; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; display: inline-flex; align-items: center; justify-content: center; gap: 10px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0, 255, 0, 0.4); }
        .btn:disabled { background: #555; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-secondary { background: transparent; color: #00ff00; border: 1px solid #00ff00; }
        .btn-secondary:hover { background: rgba(0, 255, 0, 0.1); }
        .dashboard { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-top: 20px; }
        .sidebar, .main-content { background: rgba(20, 20, 20, 0.95); border-radius: 8px; padding: 20px; border: 1px solid rgba(0, 255, 0, 0.3); }
        .project-card { background: rgba(0, 255, 0, 0.05); border: 1px solid rgba(0, 255, 0, 0.2); border-radius: 4px; padding: 15px; margin-bottom: 15px; transition: all 0.3s ease; }
        .project-card:hover { border-color: #00ff00; background: rgba(0, 255, 0, 0.1); }
        .project-card h4 { color: #00ff00; margin-bottom: 8px; }
        .project-card p { font-size: 12px; color: #aaa; margin-bottom: 4px; }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .status-active, .status-pending { background: rgba(255, 255, 0, 0.3); color: #ffff00; } .status-confirmed { background: rgba(0, 255, 0, 0.3); color: #00ff00; } .status-complete { background: rgba(0, 150, 255, 0.3); color: #0096ff; }
        .message-container { height: 300px; overflow-y: auto; border: 1px solid rgba(0, 255, 0, 0.2); border-radius: 4px; padding: 15px; margin-bottom: 15px; background: rgba(0, 0, 0, 0.5); display: flex; flex-direction: column; }
        .message { margin-bottom: 15px; padding: 10px; border-radius: 4px; max-width: 80%; }
        .message.sent { background: rgba(0, 255, 0, 0.1); border: 1px solid rgba(0, 255, 0, 0.3); align-self: flex-end; }
        .message.received { background: rgba(100, 100, 100, 0.1); border: 1px solid rgba(100, 100, 100, 0.3); align-self: flex-start; }
        .message-input-container { display: flex; gap: 10px; }
        .message-input-container input { flex: 1; }
        .view { display: none; } .view.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .stat-card { background: rgba(0, 255, 0, 0.05); border: 1px solid rgba(0, 255, 0, 0.3); border-radius: 8px; padding: 20px; text-align: center; }
        .stat-value { font-size: 32px; color: #00ff00; font-weight: bold; margin-bottom: 5px; }
        .stat-label { color: #888; font-size: 12px; text-transform: uppercase; }
        #alert-container { position: fixed; top: 20px; right: 20px; z-index: 1000; width: 300px; }
        .alert { padding: 15px; border-radius: 4px; margin-bottom: 10px; animation: slideIn 0.3s ease; }
        .alert-success { background: rgba(0, 255, 0, 0.2); border: 1px solid #00ff00; color: #00ff00; }
        .alert-error { background: rgba(255, 0, 0, 0.2); border: 1px solid #ff0000; color: #ff0000; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(0, 255, 0, 0.3); border-top: 2px solid #00ff00; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* --- NEW STRIPE STYLES --- */
        #payment-element {
            margin-bottom: 24px;
            background: rgba(0, 255, 0, 0.05);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 4px;
            padding: 12px;
        }
        #payment-message {
            color: #ff0000;
            font-size: 14px;
            text-align: center;
            margin-top: 15px;
        }

        @media (max-width: 768px) { .dashboard, .nav-cards { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="matrix-bg"></div>
    <div class="terminal-container">
        <div id="alert-container"></div>
        <div id="terminal-view" class="view active">
            <div class="terminal-window">
                <div class="terminal-header">
                    <span class="terminal-button red"></span><span class="terminal-button yellow"></span><span class="terminal-button green"></span>
                    <span class="terminal-title">LUCTHELEO TERMINAL v2.0 - Connected to Backend</span>
                </div>
                <div class="terminal-body" id="terminal-body">
                    <div class="terminal-output" id="terminal-output">
                        <div class="terminal-line">╔════════════════════════════════════════════════════╗</div>
                        <div class="terminal-line">║     LUCTHELEO TERMINAL - CREATIVE COACHING        ║</div>
                        <div class="terminal-line">║   Alternative R&B • Cyber Neo Louisiana • Music   ║</div>
                        <div class="terminal-line">╚════════════════════════════════════════════════════╝</div>
                        <div class="terminal-line"></div>
                        <div class="terminal-line">Welcome to the LUCTHELEO creative ecosystem.</div>
                        <div class="terminal-line">System Status: <span id="system-status">Checking...</span></div>
                        <div class="terminal-line">Type 'help' for available commands or use the navigation below.</div>
                    </div>
                    <div class="command-line">
                        <span class="prompt">ltl@terminal:~$</span>
                        <input type="text" id="terminal-input" autofocus>
                        <span class="cursor"></span>
                    </div>
                </div>
            </div>
            <div class="nav-cards">
                <div class="nav-card" onclick="showView('booking-view')"><h3>BOOK SESSION</h3><p>Schedule your creative coaching session. $75/hour.</p></div>
                <div class="nav-card" onclick="showView('login-view')"><h3>CLIENT PORTAL</h3><p>Access your dashboard, projects, and session history.</p></div>
                <div class="nav-card" onclick="showView('portfolio-view')"><h3>PORTFOLIO</h3><p>Explore LUCTHELEO's creative works.</p></div>
                <div class="nav-card" onclick="showView('stats-view')"><h3>SYSTEM STATUS</h3><p>Live analytics and system performance metrics.</p></div>
            </div>
        </div>
        
        <div id="booking-view" class="view">
            <button class="btn btn-secondary" onclick="showView('terminal-view')">← Back to Terminal</button>
            <div class="form-container">
                <h2 style="color: #00ff00; margin-bottom: 20px;">Book Your Creative Session</h2>
                <!-- This form is now for payment -->
                <form id="payment-form">
                    <div class="form-group"><label for="client-name">Full Name *</label><input type="text" id="client-name" required></div>
                    <div class="form-group"><label for="client-email">Email Address *</label><input type="email" id="client-email" required></div>
                    <div class="form-group"><label for="service-type">Service Type *</label><select id="service-type" required><option value="">Select a service...</option><option value="music-production">Music Production - $75</option><option value="creative-writing">Creative Writing Support - $75</option><option value="concept-development">Concept Development - $75</option><option value="building-strategy">Building Strategy - $75</option></select></div>
                    <div class="form-group"><label for="session-format">Session Format *</label><select id="session-format" required><option value="">Select format...</option><option value="online">Online (Discord)</option><option value="in-person">In-Person (Atlanta Area)</option></select></div>
                    <div class="form-group"><label for="preferred-date">Preferred Date</label><input type="date" id="preferred-date"></div>
                    <div class="form-group"><label for="experience-level">Experience Level</label><select id="experience-level"><option value="beginner">Beginner</option><option value="intermediate">Intermediate</option><option value="advanced">Advanced</option></select></div>
                    <div class="form-group"><label for="project-description">Project Description *</label><textarea id="project-description" required placeholder="Tell us about your creative project and goals..."></textarea></div>
                    
                    <!-- Stripe Elements will be inserted here -->
                    <div id="payment-element"></div>
                    
                    <button type="submit" class="btn" id="submit-payment">
                        <span id="button-text">Pay $75 & Book</span>
                        <span id="payment-spinner" class="loading" style="display: none;"></span>
                    </button>
                    <div id="payment-message" class="hidden"></div>
                </form>
            </div>
        </div>
        
        <!-- Other views (Login, Dashboard, etc.) are unchanged -->
        <div id="login-view" class="view">
            <button class="btn btn-secondary" onclick="showView('terminal-view')">← Back to Terminal</button>
            <div class="form-container" style="max-width: 400px; margin: 50px auto;">
                <h2 style="color: #00ff00; margin-bottom: 20px;">Client Portal Access</h2>
                <form id="login-form">
                    <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required></div>
                    <div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" required></div>
                    <button type="submit" class="btn" id="login-submit"><span id="login-btn-text">Access Portal</span><span id="login-loading" class="loading" style="display: none;"></span></button>
                </form>
            </div>
        </div>
        <div id="dashboard-view" class="view">
            <button class="btn btn-secondary" onclick="logout()">← Logout</button>
            <h2 style="color: #00ff00; margin: 20px 0;">Welcome back, <span id="user-name"></span></h2>
            <div class="dashboard">
                <div class="sidebar">
                    <h3 style="color: #00ff00; margin-bottom: 15px;">Quick Actions</h3>
                    <button class="btn" style="width: 100%; margin-bottom: 10px;" onclick="showView('booking-view')">Book New Session</button>
                    <button class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;">Upload Files</button>
                    <button class="btn btn-secondary" style="width: 100%;">View Invoices</button>
                    <h3 style="color: #00ff00; margin: 30px 0 15px;">Session History</h3>
                    <div id="session-history"><p style="color:#888; font-size: 12px;">No sessions completed yet.</p></div>
                </div>
                <div class="main-content">
                    <h3 style="color: #00ff00; margin-bottom: 15px;">Your Bookings</h3>
                    <div id="bookings-list"><p style="color:#888; font-size: 12px;">No active bookings found.</p></div>
                    <h3 style="color: #00ff00; margin: 30px 0 15px;">Messages</h3>
                    <div class="message-container" id="message-container"></div>
                    <form id="message-form" class="message-input-container">
                        <input type="text" id="message-input" placeholder="Type your message..."><button type="submit" class="btn">Send</button>
                    </form>
                </div>
            </div>
        </div>
        <div id="portfolio-view" class="view">
            <button class="btn btn-secondary" onclick="showView('terminal-view')">← Back to Terminal</button>
            <h2 style="color: #00ff00; margin: 20px 0;">LUCTHELEO Portfolio</h2>
            <div class="nav-cards">
                <div class="nav-card"><h3>Latest Track: "Cyber Dreams"</h3><p>Alternative R&B production.</p></div>
                <div class="nav-card"><h3>Studio Session: Beat Making</h3><p>Watch the creative process.</p></div>
                <div class="nav-card"><h3>Visual Art: Noir Expressions</h3><p>Digital artwork.</p></div>
                <div class="nav-card"><h3>Writing Sample: "Terminal Love"</h3><p>Lyrical exploration.</p></div>
            </div>
        </div>
        <div id="stats-view" class="view">
            <button class="btn btn-secondary" onclick="showView('terminal-view')">← Back to Terminal</button>
            <h2 style="color: #00ff00; margin: 20px 0;">System Analytics</h2>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="visitor-count">0</div><div class="stat-label">Visitors Today</div></div>
                <div class="stat-card"><div class="stat-value" id="booking-count">0</div><div class="stat-label">Total Bookings</div></div>
                <div class="stat-card"><div class="stat-value" id="user-count">0</div><div class="stat-label">Active Users</div></div>
                <div class="stat-card"><div class="stat-value" id="db-status" style="font-size: 16px;">CHECKING...</div><div class="stat-label">Database Status</div></div>
            </div>
        </div>
    </div>
    
    <script>
        // ===================================================================================
        // CONFIGURATION & STATE
        // ===================================================================================
        const API_URL = 'http://localhost:5000/api';
        // Use the Stripe Publishable Key from your .env file
        const STRIPE_PUBLISHABLE_KEY = 'pk_test_51S0XueGmLSn1r7SlUqilbMsTB4kjNAELiq6T1VKecu6MBpgfve21jY3lIuTRZSYqbFPQj6UG5Roehsp8rhMFAZKz00zpIYbuPT';
        const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
        let currentUser = null;
        let elements; // Stripe elements

        // ===================================================================================
        // INITIALIZATION
        // ===================================================================================
        window.addEventListener('load', function() {
            createMatrixEffect();
            checkSystemStatus();
            initializeStripe();
        });
        
        // ===================================================================================
        // STRIPE PAYMENT LOGIC
        // ===================================================================================
        async function initializeStripe() {
            // Fetch a payment intent and client secret from your server
            const { clientSecret } = await fetch(`${API_URL}/create-payment-intent`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
            }).then((res) => res.json());

            // Create and mount the Payment Element
            elements = stripe.elements({ clientSecret });
            const paymentElement = elements.create("payment");
            paymentElement.mount("#payment-element");
        }

        document.getElementById('payment-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            setLoading(true);

            // First, try to confirm the payment with Stripe
            const { error: stripeError } = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    // Make sure to change this to your payment completion page
                    return_url: window.location.href,
                },
                redirect: "if_required" // This prevents an immediate redirect
            });

            if (stripeError) {
                if (stripeError.type === "card_error" || stripeError.type === "validation_error") {
                    showMessage(stripeError.message);
                } else {
                    showMessage("An unexpected error occurred.");
                }
                setLoading(false);
                return;
            }

            // If payment is successful, then create the booking in your database
            await createBooking();
            setLoading(false);
        });

        async function createBooking() {
            const bookingData = {
                clientName: document.getElementById('client-name').value,
                clientEmail: document.getElementById('client-email').value,
                serviceType: document.getElementById('service-type').value,
                sessionFormat: document.getElementById('session-format').value,
                preferredDate: document.getElementById('preferred-date').value,
                experienceLevel: document.getElementById('experience-level').value,
                projectDescription: document.getElementById('project-description').value,
            };

            try {
                const response = await fetch(`${API_URL}/bookings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData)
                });
                const result = await response.json();
                if (!response.ok || !result.success) throw new Error(result.error || 'Failed to create booking.');

                const tempPassword = result.tempPassword;
                showAlert(`Payment successful! Your temporary password is: ${tempPassword}`, 'success');
                document.getElementById('payment-form').reset();
                showView('terminal-view');
                appendTerminalLine(`New booking created for ${bookingData.clientEmail}.\nYour login credentials are:\nEmail: ${bookingData.clientEmail}\nPassword: ${tempPassword}\nUse the 'login' command to access your dashboard.`);

            } catch (error) {
                console.error('Booking failed:', error);
                showAlert(error.message, 'error');
            }
        }

        function setLoading(isLoading) {
            const submitBtn = document.getElementById('submit-payment');
            const spinner = document.getElementById('payment-spinner');
            const btnText = document.getElementById('button-text');

            submitBtn.disabled = isLoading;
            spinner.style.display = isLoading ? 'inline-block' : 'none';
            btnText.style.display = isLoading ? 'none' : 'inline';
        }

        function showMessage(messageText) {
            const messageContainer = document.querySelector("#payment-message");
            messageContainer.textContent = messageText;
            setTimeout(() => { messageContainer.textContent = ""; }, 4000);
        }

        // ===================================================================================
        // OTHER FUNCTIONS (UI, API, Terminal, Dashboard etc.)
        // ===================================================================================
        function createMatrixEffect() {
            const matrix = document.getElementById('matrix-bg');
            if (matrix.children.length > 0) return;
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*()';
            const columnCount = Math.floor(window.innerWidth / 20);
            for (let i = 0; i < columnCount; i++) {
                const column = document.createElement('div');
                column.className = 'matrix-column';
                column.style.left = `${Math.random() * 100}%`;
                column.style.animationDuration = `${Math.random() * 8 + 7}s`;
                column.style.animationDelay = `${Math.random() * 10}s`;
                let text = '';
                for (let j = 0; j < 30; j++) { text += characters.charAt(Math.floor(Math.random() * characters.length)) + '<br>'; }
                column.innerHTML = text;
                matrix.appendChild(column);
            }
        }
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            const activeView = document.getElementById(viewId);
            if (activeView) activeView.classList.add('active');
            if (viewId === 'stats-view') loadStats();
            if (viewId === 'booking-view') initializeStripe(); // Re-initialize Stripe when view is shown
        }
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            container.appendChild(alertDiv);
            setTimeout(() => { alertDiv.style.opacity = '0'; setTimeout(() => alertDiv.remove(), 300); }, 5000);
        }
        async function checkSystemStatus() {
            const statusEl = document.getElementById('system-status');
            try {
                const response = await fetch(`${API_URL}/test`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                statusEl.innerHTML = `<span style="color: #00ff00;">ONLINE - Database: ${data.database}</span>`;
            } catch (error) {
                console.error("System status check failed:", error);
                statusEl.innerHTML = `<span style="color: #ff0000;">OFFLINE - Backend not connected</span>`;
            }
        }
        async function loadStats() {
            const bookingCountEl = document.getElementById('booking-count');
            const userCountEl = document.getElementById('user-count');
            const dbStatusEl = document.getElementById('db-status');
            try {
                const bookingsResponse = await fetch(`${API_URL}/bookings`);
                const bookings = await bookingsResponse.json();
                bookingCountEl.textContent = bookings.length;
                const usersResponse = await fetch(`${API_URL}/users`);
                const users = await usersResponse.json();
                userCountEl.textContent = users.length;
                dbStatusEl.innerHTML = '<span style="color: #00ff00;">CONNECTED</span>';
            } catch (error) {
                console.error("Failed to load stats:", error);
                bookingCountEl.textContent = 'N/A';
                userCountEl.textContent = 'N/A';
                dbStatusEl.innerHTML = '<span style="color: #ff0000;">DISCONNECTED</span>';
            }
            const visitorCount = parseInt(localStorage.getItem('visitorCount') || '0') + 1;
            localStorage.setItem('visitorCount', visitorCount);
            document.getElementById('visitor-count').textContent = visitorCount;
        }
        const commands = {
            help: () => `Available commands:\n• help\n• clear\n• status\n• book\n• login\n• portfolio\n• about\n• stats`,
            clear: () => { document.getElementById('terminal-output').innerHTML = ''; return ''; },
            status: () => { checkSystemStatus(); return 'Checking system status...'; },
            book: () => { showView('booking-view'); return 'Opening booking system...'; },
            login: () => { showView('login-view'); return 'Accessing client portal...'; },
            portfolio: () => { showView('portfolio-view'); return 'Loading portfolio...'; },
            about: () => `LUCTHELEO Terminal v2.0\nCreative Coaching & Music Production\nServices: $75/session`,
            stats: () => { showView('stats-view'); return 'Loading analytics...'; }
        };
        document.getElementById('terminal-input').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const command = event.target.value.trim().toLowerCase();
                if (command) {
                    appendTerminalLine(`ltl@terminal:~$ ${command}`);
                    const output = commands[command] ? commands[command]() : `Command not found: ${command}. Type 'help'.`;
                    if (output) appendTerminalLine(output);
                }
                event.target.value = '';
            }
        });
        function appendTerminalLine(text) {
            const outputEl = document.getElementById('terminal-output');
            const terminalBody = document.getElementById('terminal-body');
            const line = document.createElement('div');
            line.className = 'terminal-line';
            line.textContent = text;
            outputEl.appendChild(line);
            terminalBody.scrollTop = terminalBody.scrollHeight;
        }
        document.getElementById('login-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('login-submit');
            const btnText = document.getElementById('login-btn-text');
            const loadingSpinner = document.getElementById('login-loading');
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            loadingSpinner.style.display = 'inline-block';
            const loginData = { email: document.getElementById('login-email').value, password: document.getElementById('login-password').value };
            try {
                const response = await fetch(`${API_URL}/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(loginData) });
                const result = await response.json();
                if (!response.ok || !result.success) throw new Error(result.error || 'Login failed.');
                currentUser = result.user;
                showAlert(`Welcome back, ${currentUser.name}!`, 'success');
                this.reset();
                loadDashboard();
                showView('dashboard-view');
            } catch (error) {
                console.error('Login failed:', error);
                showAlert(error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                loadingSpinner.style.display = 'none';
            }
        });
        document.getElementById('message-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const input = document.getElementById('message-input');
            const messageText = input.value.trim();
            if (messageText) {
                sendMessage(messageText, 'sent');
                input.value = '';
                setTimeout(() => sendMessage("Thanks for your message. I'll get back to you shortly.", 'received'), 1500);
            }
        });
        async function loadDashboard() {
            if (!currentUser) return;
            document.getElementById('user-name').textContent = currentUser.name;
            const bookingsListEl = document.getElementById('bookings-list');
            bookingsListEl.innerHTML = '<div class="loading"></div>';
            try {
                const response = await fetch(`${API_URL}/bookings`);
                const allBookings = await response.json();
                const userBookings = allBookings.filter(b => b.clientEmail === currentUser.email);
                if (userBookings.length === 0) {
                    bookingsListEl.innerHTML = `<p style="color:#888; font-size: 12px;">No active bookings found.</p>`;
                    return;
                }
                bookingsListEl.innerHTML = '';
                userBookings.forEach(booking => {
                    const card = document.createElement('div');
                    card.className = 'project-card';
                    card.innerHTML = `<h4>${booking.serviceType.replace(/-/g, ' ')}</h4><p>Format: ${booking.sessionFormat}</p><p>Booked on: ${new Date(booking.dateBooked).toLocaleDateString()}</p><span class="status-badge status-${booking.status}">${booking.status}</span>`;
                    bookingsListEl.appendChild(card);
                });
            } catch (error) {
                console.error("Failed to load dashboard bookings:", error);
                bookingsListEl.innerHTML = `<p style="color:#ff0000; font-size: 12px;">Error loading bookings.</p>`;
            }
        }
        function logout() {
            currentUser = null;
            showAlert('You have been logged out.', 'success');
            showView('terminal-view');
        }
        function sendMessage(text, type) {
            const container = document.getElementById('message-container');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.textContent = text;
            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>
